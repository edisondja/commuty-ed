# ============================================
# COMMUTY-ED - Configuración de Apache
# URLs Modernas y Amigables
# ============================================

# Habilitar motor de reescritura
RewriteEngine On
Options +FollowSymLinks -Indexes

# Base del sitio - Cambiar a "/" en producción si está en la raíz
# En XAMPP/desarrollo: /commuty-ed/
# En producción (raíz): /
RewriteBase /commuty-ed/

# ============================================
# EXCLUIR DIRECTORIOS QUE NO DEBEN SER REESCRITOS
# ============================================

# No reescribir archivos existentes ni directorios
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# Excluir explícitamente controllers, js, css, assets, videos
RewriteRule ^(controllers|js|css|assets|videos|uploads|vendor)/ - [L]

# ============================================
# RUTAS MODERNAS (URLs Amigables)
# ============================================

# Publicación individual: /post/123 o /post/123/titulo-slug
RewriteRule ^post/([0-9]+)/?$ single_board.php?id=$1 [L,QSA]
RewriteRule ^post/([0-9]+)/(.*)$ single_board.php?id=$1&slug=$2 [L,QSA]

# Perfil de usuario: /profile/username
RewriteRule ^profile/([^/]+)/?$ profile_user.php?user=$1 [L,QSA]
RewriteRule ^profile/([^/]+)/page/([0-9]+)/?$ profile_user.php?user=$1&leaf=$2 [L,QSA]
RewriteRule ^u/([^/]+)/?$ profile_user.php?user=$1 [L,QSA]

# Paginación: /page/2
RewriteRule ^page/([0-9]+)/?$ index.php?leaf=$1 [L,QSA]

# Búsqueda: /search/termino
RewriteRule ^search/(.*)$ index.php?search=$1 [L,QSA]

# Panel de administración: /admin o /admin/modulo
RewriteRule ^admin/?$ backcoffe.php [L,QSA]
RewriteRule ^admin/users/?$ backcoffe.php?option=users [L,QSA]
RewriteRule ^admin/boards/?$ backcoffe.php?option=boards [L,QSA]
RewriteRule ^admin/settings/?$ backcoffe.php?option=settings [L,QSA]
RewriteRule ^admin/reports/?$ backcoffe.php?option=reports [L,QSA]
RewriteRule ^admin/mail/?$ backcoffe.php?option=mails [L,QSA]
RewriteRule ^admin/banners/?$ backcoffe.php?option=banners [L,QSA]
RewriteRule ^admin/rabbitmq/?$ backcoffe.php?option=rabbitmq [L,QSA]
RewriteRule ^admin/monitor/?$ backcoffe.php?option=monitor [L,QSA]
RewriteRule ^admin/failures/?$ backcoffe.php?option=failures [L,QSA]
RewriteRule ^admin/styles/?$ backcoffe.php?option=estilos [L,QSA]
RewriteRule ^admin/players/?$ backcoffe.php?option=reproductores [L,QSA]

# API alternativo: /api/action -> controllers/action
RewriteRule ^api/(.*)$ controllers/$1 [L,QSA]

# Sitemap y robots
RewriteRule ^sitemap\.xml$ sitemap.php [L]
RewriteRule ^robots\.txt$ robots.txt [L]

# ============================================
# SEGURIDAD
# ============================================

# Proteger archivos sensibles
<FilesMatch "(^\.htaccess|config\.php|composer\.json|composer\.lock|\.env)$">
    Require all denied
</FilesMatch>

# ============================================
# CONFIGURACIÓN PHP
# ============================================

<IfModule mod_php.c>
    php_value upload_max_filesize 250M
    php_value post_max_size 260M
    php_value max_execution_time 600
    php_value max_input_time 600
    php_value memory_limit 256M
</IfModule>

# ============================================
# HEADERS DE SEGURIDAD
# ============================================

<IfModule mod_headers.c>
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>

# ============================================
# COMPRESIÓN Y CACHE
# ============================================

<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
</IfModule>

<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/webp "access plus 1 month"
    ExpiresByType video/mp4 "access plus 1 month"
    ExpiresByType text/css "access plus 1 week"
    ExpiresByType application/javascript "access plus 1 week"
</IfModule>
